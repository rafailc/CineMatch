name: Perfect Auto SemVer

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate and Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. --- Î‘ÎÎ‘Î›Î¥Î£Î— ÎœÎ—ÎÎ¥ÎœÎ‘Î¤ÎŸÎ£ ---
            const fullMessage = context.payload.head_commit.message; // Ï€.Ï‡. "minor: Create sss"
            const lowerMessage = fullMessage.toLowerCase();
            console.log(`Commit: "${fullMessage}"`);

            let bumpType = null;
            if (lowerMessage.includes('major:')) bumpType = 'major';
            else if (lowerMessage.includes('minor:')) bumpType = 'minor';
            else if (lowerMessage.includes('patch:')) bumpType = 'patch';

            if (!bumpType) {
              console.log('Skipping: No keyword found.');
              return;
            }

            // 2. --- ÎšÎ‘Î˜Î‘Î¡Î™Î£ÎœÎŸÎ£ ÎšÎ•Î™ÎœÎ•ÎÎŸÎ¥ (Fix Î³Î¹Î± Ï„Î¿ "minor: sss") ---
            // Î‘Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï€ÏÏŒÎ¸ÎµÎ¼Î± (minor: ÎºÎ»Ï€) Î³Î¹Î± Î½Î± Î­Ï‡Î¿Ï…Î¼Îµ ÎºÎ±Î¸Î±ÏÏŒ Ï„Î¯Ï„Î»Î¿
            let cleanTitle = fullMessage.replace(/^(major|minor|patch):\s*/i, '').trim();
            cleanTitle = cleanTitle.charAt(0).toUpperCase() + cleanTitle.slice(1);
            
            // 3. --- Î’Î¡Î™Î£ÎšÎŸÎ¥ÎœÎ• Î¤Î‘ TAGS ---
            let lastTag = 'v0.0.0';
            try {
              let output = '';
              await exec.exec('git', ['describe', '--tags', '--abbrev=0'], {
                listeners: { stdout: (data) => { output += data.toString(); } }
              });
              lastTag = output.trim();
            } catch (e) { console.log("No tags found."); }

            // 4. --- Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ ÎÎ•ÎŸÎ¥ VERSION ---
            let parts = lastTag.replace('v', '').split('.').map(num => parseInt(num, 10));
            if (parts.length < 3 || parts.some(isNaN)) parts = [0, 0, 0];
            let [major, minor, patch] = parts;

            if (bumpType === 'major') { major++; minor = 0; patch = 0; }
            else if (bumpType === 'minor') { minor++; patch = 0; }
            else if (bumpType === 'patch') { patch++; }

            const newVersion = `v${major}.${minor}.${patch}`;
            console.log(`New Version: ${newVersion}`);

            // 5. --- Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ Î¤ÎŸÎ¥ ÎÎ•ÎŸÎ¥ TAG ---
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${newVersion}`,
                sha: context.sha
              });
            } catch (e) { return; }

            // 6. --- Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ RELEASE (ÎœÎŸÎÎŸ Î“Î™Î‘ MAJOR/MINOR) ---
            if (bumpType === 'major' || bumpType === 'minor') {
              
              // Î’ÏÎ¯ÏƒÎºÎ¿Ï…Î¼Îµ Ï„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ .0 tag (BASE TAG)
              let baseTag = '';
              try {
                let baseOutput = '';
                await exec.exec('git', ['describe', '--tags', '--abbrev=0', '--match', 'v*.*.0'], {
                    listeners: { stdout: (data) => { baseOutput += data.toString(); } },
                    ignoreReturnCode: true 
                });
                baseTag = baseOutput.trim();
              } catch (e) {}
              
              if (!baseTag) baseTag = lastTag; // Fallback
              
              // --- Î¤ÎŸ ÎšÎŸÎ›Î ÎŸ Î“Î™Î‘ Î¤ÎŸ WHAT'S CHANGED ---
              // Î–Î·Ï„Î¬Î¼Îµ Î±Ï€ÏŒ Ï„Î¿ GitHub Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Ï„Î± notes ÎŸÎ§Î™ Î±Ï€ÏŒ Ï„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ patch,
              // Î±Î»Î»Î¬ Î±Ï€ÏŒ Ï„Î¿ baseTag (Ï€.Ï‡. v1.13.0) Î¼Î­Ï‡ÏÎ¹ Ï„Î¿ Ï„ÏÏÎ±.
              let autoNotes = "";
              try {
                const response = await github.rest.repos.generateReleaseNotes({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: newVersion,
                  previous_tag_name: baseTag // <--- Î‘Î¥Î¤ÎŸ Î›Î¥ÎÎ•Î™ Î¤ÎŸ Î Î¡ÎŸÎ’Î›Î—ÎœÎ‘ ÎœÎ• Î¤Î‘ Î Î‘Î›Î™Î‘ ISSUES
                });
                autoNotes = response.data.body;
              } catch (e) { console.log("Auto notes failed"); }

              // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ Link ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚ Î³Î¹Î± Î½Î± Î²Î¬Î»Î¿Ï…Î¼Îµ Ï„Î¿ Î´Î¹ÎºÏŒ Î¼Î±Ï‚ (Î±Î½ Î¸Î­Î»Î¿Ï…Î¼Îµ)
              // Î‰ Ï„Î¿ Î±Ï†Î®Î½Î¿Ï…Î¼Îµ ÏŒÏ€Ï‰Ï‚ ÎµÎ¯Î½Î±Î¹, Î±Î»Î»Î¬ Ï„ÏÏÎ± Î¸Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒ.
              // Î•Ï€Î¯ÏƒÎ·Ï‚, Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÎ¿Ï…Î¼Îµ Ï„Î± "minor:" Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î± Ï„Î¿Ï… GitHub (Î»Î¯Î³Î¿ Î´ÏÏƒÎºÎ¿Î»Î¿ Î¼Îµ regex Î±Î»Î»Î¬ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ)
              autoNotes = autoNotes.replace(/minor:\s/gi, ""); 

              // --- Î§Î¤Î™Î£Î™ÎœÎŸ Î¤ÎŸÎ¥ Î¤Î•Î›Î™ÎšÎŸÎ¥ ÎšÎ•Î™ÎœÎ•ÎÎŸÎ¥ ---
              // Î ÏÏÏ„Î· Î³ÏÎ±Î¼Î¼Î®: ÎŸ ÎºÎ±Î¸Î±ÏÏŒÏ‚ Ï„Î¯Ï„Î»Î¿Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ minor:)
              let finalBody = `## ğŸš€ ${cleanTitle}\n\n`;
              
              // Î•Î½ÏƒÏ‰Î¼Î±Ï„ÏÎ½Î¿Ï…Î¼Îµ Ï„Î± generated notes (Ï€Î¿Ï… Ï„ÏÏÎ± Î¸Î± Î­Ï‡Î¿Ï…Î½ ÎŸÎ›Î‘ Ï„Î± issues)
              finalBody += autoNotes;

              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: newVersion,
                name: `${newVersion} - ${cleanTitle}`,
                body: finalBody,
                generate_release_notes: false // Î¤Î¿ Î­Ï‡Î¿Ï…Î¼Îµ Î®Î´Î· Î³ÎµÎ½Î½Î®ÏƒÎµÎ¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± Ï€Î¹Î¿ Ï€Î¬Î½Ï‰
              });
            }
