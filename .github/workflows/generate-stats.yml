name: Repository Stats Bot

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate STATS.md
        run: |
          # 1. Define patterns for "Automatic" code
          AUTO_PATTERNS="node_modules|package-lock.json|yarn.lock|dist|build|vendor|manifest.json|weights|*-weights"

          # 2. Create output folder
          mkdir -p stats-out
          
          # 3. IDENTIFY EXCLUSIONS
          # Exclusion 1: HTML Reports (PR #33)
          BAD_FILES=$(find . \( -path "*/htmlReport/*" -o -name "Test Results - MovieControllerTest.html" \) -type f 2>/dev/null || true)
          TOTAL_BAD_LINES=0
          if [ -n "$BAD_FILES" ]; then
            while IFS= read -r file; do
              lines=$(wc -l < "$file" | xargs)
              TOTAL_BAD_LINES=$((TOTAL_BAD_LINES + lines))
            done <<< "$BAD_FILES"
          fi
          
          # Fallback: If files are already deleted, we use a known estimate or the last calculated count
          if [ "$TOTAL_BAD_LINES" -eq 0 ]; then
             TOTAL_BAD_LINES=2500 # Adjust this number if you know the exact line count from PR #33
          fi

          SUPA_BAD_LINES=574

          # 4. Calculate Project Total
          TOTAL_PROJECT_LINES=$(git log --numstat --pretty=tformat: --no-merges | \
                                grep -vE "$AUTO_PATTERNS" | \
                                awk '{ add += $1; subs += $2 } END { print add - subs }')

          echo "# Repository Statistics" > stats-out/STATS.md
          echo "Last updated: $(date -u)" >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          echo "### ðŸ“ˆ Total Manual Lines currently in Project: **${TOTAL_PROJECT_LINES:-0}**" >> stats-out/STATS.md
          echo "> Note: Total Manual Lines is the current size of the project (Total Additions minus Total Deletions)." >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          
          echo "## ðŸ“Š Contributor Impact" >> stats-out/STATS.md
          echo "| Author | Manual (+) | Manual (-) | Styles (.css) | Auto/Pkg |" >> stats-out/STATS.md
          echo "| :--- | :--- | :--- | :--- | :--- |" >> stats-out/STATS.md

          # 5. Calculate stats for each author
          git log --format='%aN' | sort -u | while read author; do
            stats_raw=$(git log --author="$author" --numstat --pretty=tformat: --no-merges)
            
            manual_stats=$(echo "$stats_raw" | grep -vE "$AUTO_PATTERNS" | grep -v "\.css" | \
                    awk '{ add += $1; subs += $2 } END { if (add == "") add=0; if (subs == "") subs=0; printf "%s|%s", add, subs }')
            
            m_add=$(echo "$manual_stats" | cut -d'|' -f1)
            m_sub=$(echo "$manual_stats" | cut -d'|' -f2)

            # APPLY EXCLUSIONS
            # Match Panagiotis Masmanidis
            if [[ "$author" == *"Panagiotis Masmanidis"* ]]; then
              m_add=$((m_add - TOTAL_BAD_LINES))
            fi

            # Match Lefteris (covers Lefteris3124 or Lefteris Lemontzoglou in Git history)
            if [[ "$author" == *"Lefteris"* ]]; then
              m_add=$((m_add - SUPA_BAD_LINES))
            fi

            if [ "$m_add" -lt 0 ]; then m_add=0; fi

            s_add=$(echo "$stats_raw" | grep "\.css" | awk '{ add += $1 } END { print add+0 }')
            a_add=$(echo "$stats_raw" | grep -E "$AUTO_PATTERNS" | awk '{ add += $1 } END { print add+0 }')

            if [ "$m_add" -gt 0 ] || [ "$s_add" -gt 0 ] || [ "$a_add" -gt 0 ]; then
              echo "| $author | $m_add | $m_sub | $s_add | $a_add |" >> stats-out/STATS.md
            fi
          done

          # 6. --- APPEND THE NOTICES ---
          echo "" >> stats-out/STATS.md
          echo "---" >> stats-out/STATS.md
          echo "### âš ï¸ Notices" >> stats-out/STATS.md
          echo "1. The contributor **@PanaMasm** (Panagiotis Masmanidis) mistakenly committed HTML report files in **PR #33** (including the \`htmlReport\` directory and \`Test Results - MovieControllerTest.html\`). These lines have been excluded from their Manual (+) count." >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          echo "2. A Supabase-related folder (\`supabase/\`) containing two files (\`config.toml\` and \`index.ts\`) was unintentionally committed in **PR #104** (authored by **@Lefteris Lemontzoglou**). This added **574 lines** in total and was missed during code review. Those lines have been removed from the manual (+) count, and the files have since been deleted." >> stats-out/STATS.md

      - name: Deploy to Stats Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: stats-out
          branch: stats
          commit-message: "docs: update repository statistics [skip ci]"
          clean: true
