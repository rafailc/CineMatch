name: Repository Stats Bot

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate STATS.md
        run: |
          # 1. Define patterns for "Automatic" code
          AUTO_PATTERNS="node_modules|package-lock.json|yarn.lock|dist|build|vendor|manifest.json|weights|*-weights"

          # 2. Create output folder
          mkdir -p stats-out
          
          # 3. IDENTIFY BAD FILES & AUTHOR FIRST
          BAD_FILES=$(find . \( -path "*/htmlReport/*" -o -name "Test Results - MovieControllerTest.html" \) -type f)
          TOTAL_BAD_LINES=0
          REPORT_AUTHOR=""

          if [ -n "$BAD_FILES" ]; then
            while IFS= read -r file; do
              lines=$(wc -l < "$file" | xargs)
              TOTAL_BAD_LINES=$((TOTAL_BAD_LINES + lines))
            done <<< "$BAD_FILES"
            
            FIRST_FILE=$(echo "$BAD_FILES" | head -n 1)
            REPORT_AUTHOR=$(git log -1 --format='%aN' -- "$FIRST_FILE")
          fi

          # 4. Calculate Project Total
          TOTAL_PROJECT_LINES=$(git log --numstat --pretty=tformat: --no-merges | \
                                grep -vE "$AUTO_PATTERNS" | \
                                awk '{ add += $1; subs += $2 } END { print add - subs }')

          echo "# Repository Statistics" > stats-out/STATS.md
          echo "Last updated: $(date -u)" >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          echo "### ðŸ“ˆ Total Manual Lines currently in Project: **${TOTAL_PROJECT_LINES:-0}**" >> stats-out/STATS.md
          echo "> Note: Total Manual Lines is the current size of the project (Total Additions minus Total Deletions)." >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          
          echo "## ðŸ“Š Contributor Impact" >> stats-out/STATS.md
          echo "| Author | Manual (+) | Manual (-) | Styles (.css) | Auto/Pkg |" >> stats-out/STATS.md
          echo "| :--- | :--- | :--- | :--- | :--- |" >> stats-out/STATS.md

          # 5. Calculate stats for each author
          git log --format='%aN' | sort -u | while read author; do
            manual_stats=$(git log --author="$author" --numstat --pretty=tformat: --no-merges | \
                    grep -vE "$AUTO_PATTERNS" | grep -v "\.css" | \
                    awk '{ add += $1; subs += $2 } END { if (add == "") add=0; if (subs == "") subs=0; printf "%s|%s", add, subs }')
            
            m_add=$(echo "$manual_stats" | cut -d'|' -f1)
            m_sub=$(echo "$manual_stats" | cut -d'|' -f2)

            # Subtract "bad" lines if this author committed them
            if [ "$author" == "$REPORT_AUTHOR" ]; then
              m_add=$((m_add - TOTAL_BAD_LINES))
              if [ "$m_add" -lt 0 ]; then m_add=0; fi
            fi

            style_added=$(git log --author="$author" --numstat --pretty=tformat: --no-merges | \
                    grep "\.css" | \
                    awk '{ add += $1 } END { if (add == "") add=0; printf "%s", add }')

            auto_added=$(git log --author="$author" --numstat --pretty=tformat: --no-merges | \
                    grep -E "$AUTO_PATTERNS" | \
                    awk '{ add += $1 } END { if (add == "") add=0; printf "%s", add }')

            s_add=${style_added:-0}
            a_add=${auto_added:-0}
            
            if [ "$m_add" != "0" ] || [ "$s_add" != "0" ] || [ "$a_add" != "0" ]; then
              echo "| $author | $m_add | $m_sub | $s_add | $a_add |" >> stats-out/STATS.md
            fi
          done

          # 6. --- APPEND THE NOTICE ---
          if [ -n "$REPORT_AUTHOR" ]; then
            echo "" >> stats-out/STATS.md
            echo "---" >> stats-out/STATS.md
            echo "### âš ï¸ Notice" >> stats-out/STATS.md
            echo "The contributor **@$REPORT_AUTHOR** had mistakenly committed the HTML report files (including the htmlReport directory) and **Test Results - MovieControllerTest.html** with a total of **$TOTAL_BAD_LINES lines** that has nothing to do with the project. These lines have been excluded from their Manual (+) count above. It was to test his code and he forgot to remove it." >> stats-out/STATS.md
          fi

      - name: Deploy to Stats Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: stats-out
          branch: stats
          commit-message: "docs: update repository statistics [skip ci]"
          clean: true
