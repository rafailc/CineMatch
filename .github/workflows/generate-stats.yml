name: Repository Stats Bot

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate STATS.md
        run: |
          # 1. Define patterns for "Automatic" code
          AUTO_PATTERNS="node_modules|package-lock.json|yarn.lock|dist|build|vendor|manifest.json|weights|*-weights"

          # 2. Create output folder
          mkdir -p stats-out
          
          # 3. Calculate Project Total (Current lines in existence: Add - Sub)
          TOTAL_PROJECT_LINES=$(git log --numstat --pretty=tformat: --no-merges | \
                                grep -vE "$AUTO_PATTERNS" | \
                                awk '{ add += $1; subs += $2 } END { print add - subs }')

          echo "# Repository Statistics" > stats-out/STATS.md
          echo "Last updated: $(date -u)" >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          echo "### ðŸ“ˆ Total Manual Lines currently in Project: **${TOTAL_PROJECT_LINES:-0}**" >> stats-out/STATS.md
          echo "> Note: Total Manual Lines is the current size of the project (Total Additions minus Total Deletions)." >> stats-out/STATS.md
          echo "" >> stats-out/STATS.md
          
          echo "## ðŸ“Š Contributor Impact" >> stats-out/STATS.md
          echo "| Author | Manual (+) | Manual (-) | Net Manual | Auto/Pkg |" >> stats-out/STATS.md
          echo "| :--- | :--- | :--- | :--- | :--- |" >> stats-out/STATS.md

          # 4. Calculate stats for each author
          git log --format='%aN' | sort -u | while read author; do
            # Calculate Manual stats (Add, Sub, Net)
            manual_stats=$(git log --author="$author" --numstat --pretty=tformat: --no-merges | \
                    grep -vE "$AUTO_PATTERNS" | \
                    awk '{ add += $1; subs += $2 } END { if (add == "") add=0; if (subs == "") subs=0; printf "%s|%s|%s", add, subs, add - subs }')
            
            # Calculate Automatic additions
            auto_added=$(git log --author="$author" --numstat --pretty=tformat: --no-merges | \
                    grep -E "$AUTO_PATTERNS" | \
                    awk '{ add += $1 } END { if (add == "") add=0; printf "%s", add }')

            # Extract variables
            m_add=$(echo "$manual_stats" | cut -d'|' -f1)
            m_sub=$(echo "$manual_stats" | cut -d'|' -f2)
            m_net=$(echo "$manual_stats" | cut -d'|' -f3)
            a_add=${auto_added:-0}
            
            # Filter out authors with 0 changes
            if [ "$m_add" != "0" ] || [ "$a_add" != "0" ]; then
              echo "| $author | $m_add | $m_sub | $m_net | $a_add |" >> stats-out/STATS.md
            fi
          done

      - name: Deploy to Stats Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: stats-out
          branch: stats
          commit-message: "docs: update repository statistics [skip ci]"
          clean: true
